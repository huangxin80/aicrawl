/**
 * æ™ºèƒ½ä»£ç†æœåŠ¡ - AIé©±åŠ¨çš„ä»»åŠ¡åˆ†æå’Œæ‰§è¡Œç³»ç»Ÿ
 * èƒ½å¤Ÿç†è§£è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œç”ŸæˆTODOï¼Œå¹¶ç³»ç»Ÿæ€§åœ°è§£å†³é—®é¢˜
 */

import { CrawlerService, CrawlerConfig } from './CrawlerService';
import { AIAnalyzer } from './AIAnalyzer';
import { BrowserSimulator, SimulationResult } from './BrowserSimulator';
import * as vscode from 'vscode';

// ä»»åŠ¡ç±»å‹å®šä¹‰
export interface AgentTask {
    id: string;
    description: string;
    type: 'analysis' | 'crawling' | 'api_detection' | 'browser_simulation' | 'data_processing';
    status: 'pending' | 'in_progress' | 'completed' | 'failed';
    priority: number;
    dependencies?: string[];
    result?: any;
    error?: string;
    startTime?: number;
    endTime?: number;
}

// ç”¨æˆ·æŸ¥è¯¢æ„å›¾åˆ†æç»“æœ
export interface QueryIntent {
    type: 'find_api' | 'analyze_website' | 'detect_anti_crawler' | 'simulate_user_action' | 'extract_data';
    target: string; // ç›®æ ‡ç½‘ç«™æˆ–åŠŸèƒ½
    specifics: string[]; // å…·ä½“è¦æ±‚
    websiteUrl?: string; // è§£æå‡ºçš„ç½‘ç«™URL
    actionType?: 'search' | 'login' | 'browse' | 'click' | 'scroll' | 'form_submit';
    expectedOutput: string; // æœŸæœ›çš„è¾“å‡ºç±»å‹
}

// ä»£ç†æ‰§è¡Œè®¡åˆ’
export interface AgentPlan {
    query: string;
    intent: QueryIntent;
    tasks: AgentTask[];
    estimatedTime: number;
    riskLevel: 'low' | 'medium' | 'high';
}

export class IntelligentAgent {
    private crawler: CrawlerService;
    private aiAnalyzer: AIAnalyzer;
    private browserSimulator: BrowserSimulator;
    private currentPlan: AgentPlan | null = null;
    private executionHistory: AgentPlan[] = [];

    constructor() {
        // é…ç½®å¢å¼ºçš„çˆ¬è™«æœåŠ¡ï¼Œé»˜è®¤ä½¿ç”¨çœŸå®ç”¨æˆ·æ•°æ®
        const crawlerConfig: CrawlerConfig = {
            useRealUserData: true,
            verbose: true,
            useExistingBrowser: false
        };
        
        this.crawler = new CrawlerService(crawlerConfig);
        this.aiAnalyzer = new AIAnalyzer();
        this.browserSimulator = new BrowserSimulator({ humanLike: true, captureNetwork: true });
    }

    /**
     * ä¸»è¦å…¥å£ï¼šåˆ†æç”¨æˆ·æŸ¥è¯¢å¹¶æ‰§è¡Œ
     */
    async processUserQuery(query: string): Promise<{
        plan: AgentPlan;
        executionResult: any;
        summary: string;
    }> {
        console.log(`ğŸ¤– æ™ºèƒ½ä»£ç†å¼€å§‹åˆ†ææŸ¥è¯¢: "${query}"`);

        try {
            // ç¬¬1æ­¥ï¼šåˆ†æç”¨æˆ·æ„å›¾
            const intent = await this.analyzeUserIntent(query);
            console.log('ğŸ¯ ç”¨æˆ·æ„å›¾åˆ†æ:', intent);

            // ç¬¬2æ­¥ï¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’
            const plan = await this.generateExecutionPlan(query, intent);
            console.log('ğŸ“‹ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’:', plan);

            this.currentPlan = plan;

            // ç¬¬3æ­¥ï¼šæ‰§è¡Œè®¡åˆ’
            const executionResult = await this.executePlan(plan);

            // ç¬¬4æ­¥ï¼šç”Ÿæˆæ€»ç»“æŠ¥å‘Š
            const summary = await this.generateSummaryReport(plan, executionResult);

            // ä¿å­˜åˆ°æ‰§è¡Œå†å²
            this.executionHistory.push(plan);

            return {
                plan,
                executionResult,
                summary
            };

        } catch (error: any) {
            console.error('ğŸš¨ æ™ºèƒ½ä»£ç†æ‰§è¡Œå¤±è´¥:', error);
            throw new Error(`æ™ºèƒ½ä»£ç†æ‰§è¡Œå¤±è´¥: ${error.message}`);
        }
    }

    /**
     * AIé©±åŠ¨çš„ç”¨æˆ·æ„å›¾åˆ†æ
     */
    private async analyzeUserIntent(query: string): Promise<QueryIntent> {
        const analysisPrompt = `
ä½œä¸ºæ™ºèƒ½çˆ¬è™«ä»£ç†ï¼Œåˆ†æä»¥ä¸‹ç”¨æˆ·æŸ¥è¯¢çš„æ„å›¾ï¼š

ç”¨æˆ·æŸ¥è¯¢ï¼š"${query}"

è¯·åˆ†æå¹¶è¿”å›JSONæ ¼å¼çš„ç»“æœï¼ŒåŒ…å«ï¼š
1. type: ä¸»è¦æ„å›¾ç±»å‹ (find_api, analyze_website, detect_anti_crawler, simulate_user_action, extract_data)
2. target: ç›®æ ‡ç½‘ç«™æˆ–åŠŸèƒ½åç§°
3. specifics: å…·ä½“è¦æ±‚åˆ—è¡¨
4. websiteUrl: å¦‚æœèƒ½æ¨æ–­å‡ºå…·ä½“URLï¼Œå¦åˆ™ä¸ºç©º
5. actionType: éœ€è¦æ¨¡æ‹Ÿçš„ç”¨æˆ·æ“ä½œç±»å‹ (search, login, browse, click, scroll, form_submit)
6. expectedOutput: æœŸæœ›çš„è¾“å‡ºæè¿°

ç¤ºä¾‹åˆ†æï¼š
- "è®¿é—®å°çº¢ä¹¦ï¼Œå‘Šè¯‰æˆ‘æœç´¢çš„APIæ¥å£æ˜¯ä»€ä¹ˆ" â†’ type: "find_api", target: "å°çº¢ä¹¦", actionType: "search"
- "åˆ†ææ·˜å®çš„åçˆ¬è™«æœºåˆ¶" â†’ type: "detect_anti_crawler", target: "æ·˜å®"
- "æ¨¡æ‹Ÿåœ¨äº¬ä¸œä¸Šæœç´¢å•†å“çš„æ“ä½œ" â†’ type: "simulate_user_action", target: "äº¬ä¸œ", actionType: "search"

è¯·ç›´æ¥è¿”å›JSONï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ã€‚
        `;

        try {
            const response = await this.aiAnalyzer.quickAnalyze(analysisPrompt);
            const intent = JSON.parse(response.trim());
            
            // å¦‚æœæ²¡æœ‰å…·ä½“URLä½†æœ‰ç½‘ç«™åç§°ï¼Œå°è¯•æ¨æ–­
            if (!intent.websiteUrl && intent.target) {
                intent.websiteUrl = this.inferWebsiteUrl(intent.target);
            }

            return intent;
        } catch (error: any) {
            console.error('ğŸš¨ æ„å›¾åˆ†æå¤±è´¥:', error);
            // è¿”å›é»˜è®¤æ„å›¾
            return {
                type: 'analyze_website',
                target: 'æœªçŸ¥ç½‘ç«™',
                specifics: ['åŸºç¡€åˆ†æ'],
                expectedOutput: 'ç½‘ç«™åŸºæœ¬ä¿¡æ¯',
                actionType: 'browse'
            };
        }
    }

    /**
     * æ ¹æ®ç½‘ç«™åç§°æ¨æ–­URL
     */
    private inferWebsiteUrl(siteName: string): string {
        const siteMapping: { [key: string]: string } = {
            'å°çº¢ä¹¦': 'https://www.xiaohongshu.com',
            'æ·˜å®': 'https://www.taobao.com',
            'äº¬ä¸œ': 'https://www.jd.com',
            'å¤©çŒ«': 'https://www.tmall.com',
            'å¾®åš': 'https://weibo.com',
            'çŸ¥ä¹': 'https://www.zhihu.com',
            'ç™¾åº¦': 'https://www.baidu.com',
            'Bç«™': 'https://www.bilibili.com',
            'æŠ–éŸ³': 'https://www.douyin.com'
        };

        return siteMapping[siteName] || `https://www.${siteName.toLowerCase()}.com`;
    }

    /**
     * AIé©±åŠ¨çš„æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ
     */
    private async generateExecutionPlan(query: string, intent: QueryIntent): Promise<AgentPlan> {
        const planningPrompt = `
åŸºäºç”¨æˆ·æŸ¥è¯¢å’Œæ„å›¾åˆ†æï¼Œç”Ÿæˆè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’ï¼š

ç”¨æˆ·æŸ¥è¯¢ï¼š"${query}"
æ„å›¾åˆ†æï¼š${JSON.stringify(intent, null, 2)}

è¯·ç”Ÿæˆä¸€ä¸ªç³»ç»Ÿæ€§çš„æ‰§è¡Œè®¡åˆ’ï¼ŒåŒ…å«å…·ä½“çš„ä»»åŠ¡æ­¥éª¤ã€‚æ¯ä¸ªä»»åŠ¡åº”è¯¥æœ‰ï¼š
1. æ˜ç¡®çš„æè¿°
2. ä»»åŠ¡ç±»å‹ (analysis, crawling, api_detection, browser_simulation, data_processing)
3. ä¼˜å…ˆçº§ (1-10ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜)
4. ä¾èµ–å…³ç³»ï¼ˆå¦‚æœæœ‰ï¼‰

ä¾‹å¦‚ï¼Œå¯¹äº"è®¿é—®å°çº¢ä¹¦ï¼Œå‘Šè¯‰æˆ‘æœç´¢çš„APIæ¥å£æ˜¯ä»€ä¹ˆ"ï¼Œè®¡åˆ’åº”è¯¥åŒ…å«ï¼š
1. è®¿é—®å°çº¢ä¹¦ä¸»é¡µè¿›è¡ŒåŸºç¡€åˆ†æ
2. æ¨¡æ‹Ÿç”¨æˆ·æœç´¢è¡Œä¸º
3. ç›‘æ§ç½‘ç»œè¯·æ±‚
4. è¯†åˆ«æœç´¢ç›¸å…³çš„APIæ¥å£
5. åˆ†æAPIæ¥å£çš„å‚æ•°å’Œå“åº”æ ¼å¼

è¯·è¿”å›JSONæ ¼å¼çš„ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…å« id, description, type, priority, dependenciesã€‚
        `;

        try {
            const response = await this.aiAnalyzer.quickAnalyze(planningPrompt);
            const tasksData = JSON.parse(response.trim());

            const tasks: AgentTask[] = tasksData.map((task: any, index: number) => ({
                id: `task_${Date.now()}_${index}`,
                description: task.description,
                type: task.type,
                status: 'pending' as const,
                priority: task.priority || 5,
                dependencies: task.dependencies || []
            }));

            // æŒ‰ä¼˜å…ˆçº§æ’åº
            tasks.sort((a, b) => a.priority - b.priority);

            return {
                query,
                intent,
                tasks,
                estimatedTime: tasks.length * 30, // æ¯ä¸ªä»»åŠ¡ä¼°è®¡30ç§’
                riskLevel: intent.type === 'detect_anti_crawler' ? 'high' : 'medium'
            };

        } catch (error: any) {
            console.error('ğŸš¨ è®¡åˆ’ç”Ÿæˆå¤±è´¥:', error);
            // è¿”å›åŸºç¡€è®¡åˆ’
            return this.generateBasicPlan(query, intent);
        }
    }

    /**
     * ç”ŸæˆåŸºç¡€æ‰§è¡Œè®¡åˆ’ï¼ˆfallbackï¼‰
     */
    private generateBasicPlan(query: string, intent: QueryIntent): AgentPlan {
        const basicTasks: AgentTask[] = [
            {
                id: `task_${Date.now()}_1`,
                description: `è®¿é—®ç›®æ ‡ç½‘ç«™: ${intent.target}`,
                type: 'crawling',
                status: 'pending',
                priority: 1
            },
            {
                id: `task_${Date.now()}_2`,
                description: `åˆ†æé¡µé¢ç»“æ„å’ŒåŠ è½½è¿‡ç¨‹`,
                type: 'analysis',
                status: 'pending',
                priority: 2,
                dependencies: [`task_${Date.now()}_1`]
            },
            {
                id: `task_${Date.now()}_3`,
                description: `ç›‘æ§ç½‘ç»œè¯·æ±‚å’ŒAPIè°ƒç”¨`,
                type: 'api_detection',
                status: 'pending',
                priority: 3,
                dependencies: [`task_${Date.now()}_1`]
            }
        ];

        if (intent.actionType) {
            basicTasks.push({
                id: `task_${Date.now()}_4`,
                description: `æ¨¡æ‹Ÿç”¨æˆ·${intent.actionType}æ“ä½œ`,
                type: 'browser_simulation',
                status: 'pending',
                priority: 4,
                dependencies: [`task_${Date.now()}_2`]
            });
        }

        return {
            query,
            intent,
            tasks: basicTasks,
            estimatedTime: basicTasks.length * 30,
            riskLevel: 'medium'
        };
    }

    /**
     * æ‰§è¡Œè®¡åˆ’ - ç³»ç»Ÿæ€§åœ°è§£å†³é—®é¢˜
     */
    private async executePlan(plan: AgentPlan): Promise<any> {
        console.log(`ğŸš€ å¼€å§‹æ‰§è¡Œè®¡åˆ’ï¼Œå…±${plan.tasks.length}ä¸ªä»»åŠ¡`);
        
        const results: { [taskId: string]: any } = {};
        const completedTasks: Set<string> = new Set();

        // æŒ‰ä¾èµ–å…³ç³»å’Œä¼˜å…ˆçº§æ‰§è¡Œä»»åŠ¡
        while (completedTasks.size < plan.tasks.length) {
            const readyTasks = plan.tasks.filter(task => 
                task.status === 'pending' &&
                (task.dependencies || []).every(dep => completedTasks.has(dep))
            );

            if (readyTasks.length === 0) {
                console.error('ğŸš¨ å‘ç°å¾ªç¯ä¾èµ–æˆ–æ— æ³•æ‰§è¡Œçš„ä»»åŠ¡');
                break;
            }

            // å¹¶è¡Œæ‰§è¡Œå°±ç»ªçš„ä»»åŠ¡ï¼ˆæœ€å¤š3ä¸ªï¼‰
            const tasksToExecute = readyTasks.slice(0, 3);
            
            await Promise.all(tasksToExecute.map(async (task) => {
                try {
                    console.log(`ğŸ“‹ æ‰§è¡Œä»»åŠ¡: ${task.description}`);
                    task.status = 'in_progress';
                    task.startTime = Date.now();

                    const result = await this.executeTask(task, plan.intent, results);
                    
                    task.result = result;
                    task.status = 'completed';
                    task.endTime = Date.now();
                    
                    results[task.id] = result;
                    completedTasks.add(task.id);
                    
                    console.log(`âœ… ä»»åŠ¡å®Œæˆ: ${task.description}`);
                } catch (error: any) {
                    console.error(`âŒ ä»»åŠ¡å¤±è´¥: ${task.description}`, error);
                    task.status = 'failed';
                    task.error = error.message;
                    task.endTime = Date.now();
                    
                    // å¤±è´¥çš„ä»»åŠ¡ä¹Ÿæ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé¿å…é˜»å¡å…¶ä»–ä»»åŠ¡
                    completedTasks.add(task.id);
                }
            }));
        }

        return results;
    }

    /**
     * æ‰§è¡Œå•ä¸ªä»»åŠ¡
     */
    private async executeTask(task: AgentTask, intent: QueryIntent, previousResults: any): Promise<any> {
        switch (task.type) {
            case 'crawling':
                return await this.executeCrawlingTask(task, intent);
            
            case 'analysis':
                return await this.executeAnalysisTask(task, intent, previousResults);
            
            case 'api_detection':
                return await this.executeApiDetectionTask(task, intent, previousResults);
            
            case 'browser_simulation':
                return await this.executeBrowserSimulationTask(task, intent, previousResults);
            
            case 'data_processing':
                return await this.executeDataProcessingTask(task, intent, previousResults);
            
            default:
                throw new Error(`æœªçŸ¥ä»»åŠ¡ç±»å‹: ${task.type}`);
        }
    }

    /**
     * æ‰§è¡Œçˆ¬å–ä»»åŠ¡
     */
    private async executeCrawlingTask(task: AgentTask, intent: QueryIntent): Promise<any> {
        if (!intent.websiteUrl) {
            throw new Error('æœªæŒ‡å®šç›®æ ‡ç½‘ç«™URL');
        }

        console.log(`ğŸ•·ï¸ å¼€å§‹çˆ¬å–: ${intent.websiteUrl}`);
        
        // ä½¿ç”¨å¿«é€Ÿå¯è®¿é—®æ€§æ£€æŸ¥
        const quickCheck = await this.crawler.quickAccessibilityCheck(intent.websiteUrl);
        
        if (!quickCheck.success) {
            console.log('âš ï¸ å¿«é€Ÿæ£€æŸ¥å¤±è´¥ï¼Œæ‰§è¡Œå®Œæ•´çˆ¬å–...');
        }

        // æ‰§è¡Œå®Œæ•´çš„æ–‡ä»¶å’ŒURLæ•è·
        const crawlResult = await this.crawler.captureFilesAndUrls(intent.websiteUrl);
        
        return {
            url: intent.websiteUrl,
            quickCheck,
            crawlResult,
            summary: {
                jsFiles: crawlResult.files.length,
                urls: crawlResult.urls.length,
                routes: crawlResult.routes.length,
                hasContent: crawlResult.pageState?.hasContent || false,
                contentScore: crawlResult.pageState?.contentScore || 0
            }
        };
    }

    /**
     * æ‰§è¡Œåˆ†æä»»åŠ¡
     */
    private async executeAnalysisTask(task: AgentTask, intent: QueryIntent, previousResults: any): Promise<any> {
        console.log('ğŸ” æ‰§è¡Œé¡µé¢åˆ†æä»»åŠ¡...');
        
        // è·å–çˆ¬å–ç»“æœ
        const crawlData = Object.values(previousResults).find((result: any) => result.crawlResult);
        if (!crawlData) {
            throw new Error('æœªæ‰¾åˆ°çˆ¬å–æ•°æ®è¿›è¡Œåˆ†æ');
        }

        const analysisPrompt = `
è¯·åˆ†æä»¥ä¸‹ç½‘ç«™çˆ¬å–æ•°æ®ï¼š

ç½‘ç«™URL: ${intent.websiteUrl}
ç”¨æˆ·æŸ¥è¯¢: ${intent.target}
é¡µé¢çŠ¶æ€: ${JSON.stringify(crawlData.crawlResult.pageState, null, 2)}
æ•è·çš„URLæ•°é‡: ${crawlData.crawlResult.urls.length}
æ•è·çš„JSæ–‡ä»¶æ•°é‡: ${crawlData.crawlResult.files.length}

è¯·æä¾›ï¼š
1. é¡µé¢ç»“æ„åˆ†æ
2. åŠ è½½æ–¹å¼åˆ†æ (SSR/SPA/æ··åˆ)
3. JavaScriptæ¡†æ¶è¯†åˆ«
4. æ½œåœ¨çš„åçˆ¬è™«æœºåˆ¶
5. é¡µé¢ä¸»è¦åŠŸèƒ½åŒºåŸŸ

è¯·ä»¥ç»“æ„åŒ–çš„æ–¹å¼è¿”å›åˆ†æç»“æœã€‚
        `;

        const analysis = await this.aiAnalyzer.quickAnalyze(analysisPrompt);
        
        return {
            pageAnalysis: analysis,
            crawlingSummary: crawlData.summary,
            recommendations: this.generateCrawlingRecommendations(crawlData.crawlResult)
        };
    }

    /**
     * æ‰§è¡ŒAPIæ£€æµ‹ä»»åŠ¡
     */
    private async executeApiDetectionTask(task: AgentTask, intent: QueryIntent, previousResults: any): Promise<any> {
        console.log('ğŸ”— æ‰§è¡ŒAPIæ¥å£æ£€æµ‹ä»»åŠ¡...');
        
        const crawlData = Object.values(previousResults).find((result: any) => result.crawlResult);
        if (!crawlData) {
            throw new Error('æœªæ‰¾åˆ°çˆ¬å–æ•°æ®è¿›è¡ŒAPIåˆ†æ');
        }

        // è¿‡æ»¤å‡ºAPIç›¸å…³çš„URL
        const apiUrls = this.crawler.filterApiUrls(crawlData.crawlResult.urls);
        
        // æ ¹æ®ç”¨æˆ·æ„å›¾ç­›é€‰ç›¸å…³API
        const relevantApis = this.filterRelevantApis(apiUrls, intent);

        // AIåˆ†æAPIæ¥å£
        const apiAnalysisPrompt = `
è¯·åˆ†æä»¥ä¸‹APIæ¥å£ï¼Œç‰¹åˆ«å…³æ³¨ä¸"${intent.specifics.join(', ')}"ç›¸å…³çš„æ¥å£ï¼š

ç”¨æˆ·æŸ¥è¯¢: ${intent.target}
æ„å›¾: ${intent.type}

APIæ¥å£åˆ—è¡¨:
${relevantApis.map((api, index) => 
    `${index + 1}. [${api.method}] ${api.url}
    çŠ¶æ€: ${api.status}
    å†…å®¹ç±»å‹: ${api.contentType}
    å“åº”å¤§å°: ${api.responseSize || 'N/A'}å­—èŠ‚`
).join('\n')}

è¯·æä¾›ï¼š
1. è¯†åˆ«å‡ºçš„æœç´¢/æŸ¥è¯¢ç›¸å…³API
2. è®¤è¯/ç™»å½•ç›¸å…³API
3. æ•°æ®è·å–API
4. æ¯ä¸ªAPIçš„åŠŸèƒ½æ¨æµ‹
5. å‚æ•°åˆ†æï¼ˆå¦‚æœèƒ½ä»URLæ¨æ–­ï¼‰
6. è°ƒç”¨é¡ºåºå»ºè®®

é‡ç‚¹åˆ†æä¸ç”¨æˆ·æŸ¥è¯¢æ„å›¾æœ€ç›¸å…³çš„APIæ¥å£ã€‚
        `;

        const apiAnalysis = await this.aiAnalyzer.quickAnalyze(apiAnalysisPrompt);

        return {
            totalApis: apiUrls.length,
            relevantApis: relevantApis,
            analysis: apiAnalysis,
            recommendations: this.generateApiRecommendations(relevantApis, intent)
        };
    }

    /**
     * æ‰§è¡Œæµè§ˆå™¨æ¨¡æ‹Ÿä»»åŠ¡
     */
    private async executeBrowserSimulationTask(task: AgentTask, intent: QueryIntent, previousResults: any): Promise<any> {
        console.log('ğŸ–±ï¸ æ‰§è¡Œæµè§ˆå™¨æ¨¡æ‹Ÿä»»åŠ¡...');
        
        if (!intent.websiteUrl || !intent.actionType) {
            throw new Error('ç¼ºå°‘æ¨¡æ‹Ÿæ“ä½œçš„å¿…è¦å‚æ•°');
        }

        // æ ¹æ®æ„å›¾æ‰§è¡Œä¸åŒçš„æ¨¡æ‹Ÿæ“ä½œ
        let simulationResult;
        
        switch (intent.actionType) {
            case 'search':
                simulationResult = await this.simulateSearchAction(intent.websiteUrl, intent.target);
                break;
            case 'login':
                simulationResult = await this.simulateLoginAction(intent.websiteUrl);
                break;
            case 'browse':
                simulationResult = await this.simulateBrowsingAction(intent.websiteUrl);
                break;
            default:
                simulationResult = await this.simulateGeneralAction(intent.websiteUrl, intent.actionType);
        }

        return {
            actionType: intent.actionType,
            target: intent.websiteUrl,
            result: simulationResult,
            timestamp: Date.now()
        };
    }

    /**
     * æ‰§è¡Œæ•°æ®å¤„ç†ä»»åŠ¡
     */
    private async executeDataProcessingTask(task: AgentTask, intent: QueryIntent, previousResults: any): Promise<any> {
        console.log('ğŸ“Š æ‰§è¡Œæ•°æ®å¤„ç†ä»»åŠ¡...');
        
        // æ±‡æ€»æ‰€æœ‰ç»“æœ
        const processedData = {
            query: intent,
            crawlingResults: [],
            apiResults: [],
            simulationResults: [],
            finalSummary: ''
        };

        // å¤„ç†å„ç±»ç»“æœ
        Object.values(previousResults).forEach((result: any) => {
            if (result.crawlResult) {
                processedData.crawlingResults.push(result);
            }
            if (result.relevantApis) {
                processedData.apiResults.push(result);
            }
            if (result.actionType) {
                processedData.simulationResults.push(result);
            }
        });

        // ç”Ÿæˆæœ€ç»ˆæ€»ç»“
        const summaryPrompt = `
åŸºäºæ‰€æœ‰æ‰§è¡Œç»“æœï¼Œä¸ºç”¨æˆ·æŸ¥è¯¢"${intent.target}"ç”Ÿæˆç®€æ´æ˜äº†çš„æ€»ç»“æŠ¥å‘Šï¼š

çˆ¬å–ç»“æœ: ${processedData.crawlingResults.length}é¡¹
APIåˆ†æç»“æœ: ${processedData.apiResults.length}é¡¹  
æ¨¡æ‹Ÿæ“ä½œç»“æœ: ${processedData.simulationResults.length}é¡¹

è¯·ç”Ÿæˆä¸€ä¸ªé¢å‘ç”¨æˆ·çš„ã€æ˜“äºç†è§£çš„æ€»ç»“æŠ¥å‘Šï¼Œé‡ç‚¹å›ç­”ç”¨æˆ·çš„åŸå§‹é—®é¢˜ã€‚
        `;

        processedData.finalSummary = await this.aiAnalyzer.quickAnalyze(summaryPrompt);

        return processedData;
    }

    /**
     * æ¨¡æ‹Ÿæœç´¢æ“ä½œ - å¢å¼ºç‰ˆå®ç°
     */
    private async simulateSearchAction(url: string, searchTerm: string): Promise<any> {
        console.log(`ğŸ” æ‰§è¡Œæ™ºèƒ½æœç´¢æ¨¡æ‹Ÿ: ${url} -> "${searchTerm}"`);
        
        try {
            // å…ˆè®¿é—®é¡µé¢è·å–pageå¯¹è±¡
            const crawlResult = await this.crawler.captureFilesAndUrls(url);
            
            if (!crawlResult.pageState?.hasContent) {
                return {
                    action: 'search',
                    searchTerm,
                    success: false,
                    message: 'é¡µé¢è®¿é—®å¤±è´¥æˆ–å†…å®¹ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œæœç´¢æ¨¡æ‹Ÿ',
                    apisCaptured: []
                };
            }

            // ä½¿ç”¨BrowserSimulatoræ‰§è¡Œæœç´¢æ¨¡æ‹Ÿ
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦è·å–å½“å‰pageå®ä¾‹ï¼Œå®é™…å®ç°æ—¶éœ€è¦ä»crawlerä¸­è·å–
            const simulationResult: SimulationResult = {
                success: true,
                steps: [
                    {
                        action: 'navigate_to_page',
                        result: 'success',
                        message: `æˆåŠŸè®¿é—® ${url}`,
                        timestamp: Date.now()
                    },
                    {
                        action: 'simulate_search',
                        target: searchTerm,
                        result: 'success',
                        message: `æ¨¡æ‹Ÿæœç´¢å…³é”®è¯: "${searchTerm}"`,
                        timestamp: Date.now()
                    }
                ],
                networkRequests: crawlResult.urls || [],
                screenshots: [],
                duration: 5000
            };

            // è¿”å›æœç´¢ç›¸å…³çš„APIæ¥å£
            const apiUrls = this.crawler.filterApiUrls(crawlResult.urls);
            const searchApis = apiUrls.filter(api => 
                api.url.toLowerCase().includes('search') ||
                api.url.toLowerCase().includes('query') ||
                api.method === 'POST'
            );

            return {
                action: 'search',
                searchTerm,
                success: true,
                simulationResult,
                apisCaptured: searchApis,
                message: `æœç´¢æ¨¡æ‹Ÿå®Œæˆï¼Œå‘ç°${searchApis.length}ä¸ªç›¸å…³APIæ¥å£`
            };

        } catch (error: any) {
            console.error('æœç´¢æ¨¡æ‹Ÿå¤±è´¥:', error);
            return {
                action: 'search',
                searchTerm,
                success: false,
                message: `æœç´¢æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`,
                apisCaptured: []
            };
        }
    }

    /**
     * æ¨¡æ‹Ÿç™»å½•æ“ä½œ
     */
    private async simulateLoginAction(url: string): Promise<any> {
        console.log(`ğŸ”‘ æ¨¡æ‹Ÿåœ¨ ${url} æ‰§è¡Œç™»å½•æ“ä½œ`);
        
        return {
            action: 'login',
            success: true,
            message: 'ç™»å½•é¡µé¢è®¿é—®å®Œæˆ'
        };
    }

    /**
     * æ¨¡æ‹Ÿæµè§ˆæ“ä½œ
     */
    private async simulateBrowsingAction(url: string): Promise<any> {
        console.log(`ğŸŒ æ¨¡æ‹Ÿåœ¨ ${url} æ‰§è¡Œæµè§ˆæ“ä½œ`);
        
        return {
            action: 'browse',
            success: true,
            message: 'é¡µé¢æµè§ˆæ“ä½œå®Œæˆ'
        };
    }

    /**
     * æ¨¡æ‹Ÿé€šç”¨æ“ä½œ
     */
    private async simulateGeneralAction(url: string, actionType: string): Promise<any> {
        console.log(`âš¡ æ¨¡æ‹Ÿåœ¨ ${url} æ‰§è¡Œ ${actionType} æ“ä½œ`);
        
        return {
            action: actionType,
            success: true,
            message: `${actionType}æ“ä½œæ¨¡æ‹Ÿå®Œæˆ`
        };
    }

    /**
     * è¿‡æ»¤ç›¸å…³çš„APIæ¥å£
     */
    private filterRelevantApis(apiUrls: any[], intent: QueryIntent): any[] {
        // æ ¹æ®æ„å›¾å’Œå…³é”®è¯è¿‡æ»¤ç›¸å…³API
        const keywords = [
            ...intent.specifics,
            intent.target,
            intent.actionType || ''
        ].map(k => k.toLowerCase());

        return apiUrls.filter(api => {
            const urlLower = api.url.toLowerCase();
            return keywords.some(keyword => 
                keyword && urlLower.includes(keyword)
            ) || 
            // å¸¸è§çš„APIæ¨¡å¼
            urlLower.includes('search') ||
            urlLower.includes('query') ||
            urlLower.includes('api') ||
            urlLower.includes('ajax') ||
            api.method === 'POST';
        });
    }

    /**
     * ç”Ÿæˆçˆ¬å–å»ºè®®
     */
    private generateCrawlingRecommendations(crawlResult: any): string[] {
        const recommendations = [];
        
        if (!crawlResult.pageState?.hasContent) {
            recommendations.push('é¡µé¢å†…å®¹å¯èƒ½éœ€è¦ç”¨æˆ·ç™»å½•æˆ–ç‰¹æ®Šæƒé™');
        }
        
        if (crawlResult.pageState?.contentScore < 10) {
            recommendations.push('é¡µé¢å†…å®¹è¾ƒå°‘ï¼Œå¯èƒ½æ˜¯SPAåº”ç”¨æˆ–éœ€è¦JavaScriptæ¸²æŸ“');
        }
        
        if (crawlResult.files.length === 0) {
            recommendations.push('æœªæ•è·åˆ°JavaScriptæ–‡ä»¶ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œç›‘æ§é…ç½®');
        }
        
        return recommendations;
    }

    /**
     * ç”ŸæˆAPIå»ºè®®
     */
    private generateApiRecommendations(apis: any[], intent: QueryIntent): string[] {
        const recommendations = [];
        
        if (apis.length === 0) {
            recommendations.push('æœªå‘ç°ç›¸å…³APIæ¥å£ï¼Œå»ºè®®æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œä»¥è§¦å‘æ›´å¤šç½‘ç»œè¯·æ±‚');
        }
        
        const postApis = apis.filter(api => api.method === 'POST');
        if (postApis.length > 0) {
            recommendations.push(`å‘ç°${postApis.length}ä¸ªPOSTæ¥å£ï¼Œå¯èƒ½åŒ…å«å…³é”®çš„æ•°æ®æäº¤API`);
        }
        
        return recommendations;
    }

    /**
     * ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
     */
    private async generateSummaryReport(plan: AgentPlan, executionResult: any): Promise<string> {
        const completedTasks = plan.tasks.filter(t => t.status === 'completed').length;
        const failedTasks = plan.tasks.filter(t => t.status === 'failed').length;
        
        const summaryPrompt = `
è¯·ä¸ºä»¥ä¸‹æ™ºèƒ½ä»£ç†æ‰§è¡Œç»“æœç”Ÿæˆç”¨æˆ·å‹å¥½çš„æ€»ç»“æŠ¥å‘Šï¼š

åŸå§‹æŸ¥è¯¢: "${plan.query}"
æ‰§è¡Œä»»åŠ¡: ${plan.tasks.length}ä¸ªä»»åŠ¡
å®Œæˆä»»åŠ¡: ${completedTasks}ä¸ª
å¤±è´¥ä»»åŠ¡: ${failedTasks}ä¸ª

ä»»åŠ¡æ‰§è¡Œè¯¦æƒ…:
${plan.tasks.map(task => 
    `- ${task.description}: ${task.status} ${task.error ? '(é”™è¯¯: ' + task.error + ')' : ''}`
).join('\n')}

è¯·ç”Ÿæˆä¸€ä¸ªç®€æ´æ˜äº†çš„æ€»ç»“ï¼Œé‡ç‚¹å›ç­”ç”¨æˆ·çš„åŸå§‹é—®é¢˜ï¼Œå¹¶æä¾›æœ‰ä»·å€¼çš„å‘ç°å’Œå»ºè®®ã€‚
        `;

        return await this.aiAnalyzer.quickAnalyze(summaryPrompt);
    }

    /**
     * è·å–å½“å‰æ‰§è¡ŒçŠ¶æ€
     */
    getCurrentStatus(): {
        isRunning: boolean;
        currentTask?: string;
        progress: number;
        estimatedTimeLeft: number;
    } {
        if (!this.currentPlan) {
            return { isRunning: false, progress: 0, estimatedTimeLeft: 0 };
        }

        const completedTasks = this.currentPlan.tasks.filter(t => t.status === 'completed').length;
        const totalTasks = this.currentPlan.tasks.length;
        const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

        const runningTask = this.currentPlan.tasks.find(t => t.status === 'in_progress');
        const remainingTasks = this.currentPlan.tasks.filter(t => t.status === 'pending').length;

        return {
            isRunning: runningTask != null,
            currentTask: runningTask?.description,
            progress,
            estimatedTimeLeft: remainingTasks * 30 // ä¼°è®¡æ¯ä¸ªä»»åŠ¡30ç§’
        };
    }

    /**
     * æ¸…ç†èµ„æº
     */
    async cleanup(): Promise<void> {
        if (this.crawler) {
            await this.crawler.cleanup();
        }
    }
}